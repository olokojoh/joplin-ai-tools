(()=>{"use strict";var t={16:t=>{t.exports=require("url")},143:(t,e)=>{var o,i,n,r,a,s,l,d,u,c,g;Object.defineProperty(e,"__esModule",{value:!0}),e.ContentScriptType=e.SettingStorage=e.AppType=e.SettingItemSubType=e.SettingItemType=e.ToastType=e.ToolbarButtonLocation=e.isContextMenuItemLocation=e.MenuItemLocation=e.ModelType=e.ImportModuleOutputFormat=e.FileSystemItem=void 0,(g=e.FileSystemItem||(e.FileSystemItem={})).File="file",g.Directory="directory",(c=e.ImportModuleOutputFormat||(e.ImportModuleOutputFormat={})).Markdown="md",c.Html="html",(u=e.ModelType||(e.ModelType={}))[u.Note=1]="Note",u[u.Folder=2]="Folder",u[u.Setting=3]="Setting",u[u.Resource=4]="Resource",u[u.Tag=5]="Tag",u[u.NoteTag=6]="NoteTag",u[u.Search=7]="Search",u[u.Alarm=8]="Alarm",u[u.MasterKey=9]="MasterKey",u[u.ItemChange=10]="ItemChange",u[u.NoteResource=11]="NoteResource",u[u.ResourceLocalState=12]="ResourceLocalState",u[u.Revision=13]="Revision",u[u.Migration=14]="Migration",u[u.SmartFilter=15]="SmartFilter",u[u.Command=16]="Command",function(t){t.File="file",t.Edit="edit",t.View="view",t.Note="note",t.Tools="tools",t.Help="help",t.Context="context",t.NoteListContextMenu="noteListContextMenu",t.EditorContextMenu="editorContextMenu",t.FolderContextMenu="folderContextMenu",t.TagContextMenu="tagContextMenu"}(o=e.MenuItemLocation||(e.MenuItemLocation={})),e.isContextMenuItemLocation=function(t){return[o.Context,o.NoteListContextMenu,o.EditorContextMenu,o.FolderContextMenu,o.TagContextMenu].includes(t)},(d=e.ToolbarButtonLocation||(e.ToolbarButtonLocation={})).NoteToolbar="noteToolbar",d.EditorToolbar="editorToolbar",(l=e.ToastType||(e.ToastType={})).Info="info",l.Success="success",l.Error="error",(s=e.SettingItemType||(e.SettingItemType={}))[s.Int=1]="Int",s[s.String=2]="String",s[s.Bool=3]="Bool",s[s.Array=4]="Array",s[s.Object=5]="Object",s[s.Button=6]="Button",(a=e.SettingItemSubType||(e.SettingItemSubType={})).FilePathAndArgs="file_path_and_args",a.FilePath="file_path",a.DirectoryPath="directory_path",(r=e.AppType||(e.AppType={})).Desktop="desktop",r.Mobile="mobile",r.Cli="cli",(n=e.SettingStorage||(e.SettingStorage={}))[n.Database=1]="Database",n[n.File=2]="File",(i=e.ContentScriptType||(e.ContentScriptType={})).MarkdownItPlugin="markdownItPlugin",i.CodeMirrorPlugin="codeMirrorPlugin"},156:function(t,e,o){var i=this&&this.__awaiter||function(t,e,o,i){return new(o||(o=Promise))(function(n,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function s(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o(function(t){t(e)})).then(a,s)}l((i=i.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const n=o(998),r=o(143),a=o(692),s=o(611),l=o(16),d="你是一名知识管理助手，需根据笔记内容生成简洁、具体的中文标题。",u=["# 角色","你是一名严格的原子标签生成器。","","# 背景","用户需要从笔记内容中提炼出最基础的、不可再分的概念标签，以便后续灵活组合和检索。标签必须代表独立的语义单元。","","# 核心指令","## 三条强制规则","1. **首要实体原则**","    第一个标签必须是笔记讨论的**最核心、最具体的实体**（如软件名、项目名、特定概念）。这是唯一允许使用的专有名词标签。","","2. **绝对拆解规则**","    严禁生成任何复合标签。以下情况必须拆解：","    - 包含“的”字结构（如“数据的备份” → `数据, 备份`）","    - 由两个独立名词拼接（如“数据管理” → `数据, 管理`）","    - 由名词+动词/动名词拼接（如“格式转换” → `格式, 转换`）","","3. **词性纯净要求**","    所有标签必须是：","    - 单一概念的名词（如`Python`）","    - 或明确的动名词（如`备份`、`迁移`）","","# 操作流程","1. **锁定核心**：识别笔记中最具体的实体作为第一个标签","2. **拆解提炼**：提取其他基础动作、属性和领域概念，彻底拆解所有复合词","3. **纯净检查**：确保每个标签都是原子概念，且彼此语义独立"].join("\n"),c="tagPoolStorage",g="tagPoolPreview";let f=!1;function m(t){const e=new Set;for(const o of t){const t="string"==typeof o?o.trim():"";t&&e.add(t)}return Array.from(e).sort((t,e)=>t.localeCompare(e,"zh-Hans-CN",{sensitivity:"base"}))}function p(){return i(this,void 0,void 0,function*(){const t=yield n.default.settings.value(c);if("string"!=typeof t||!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e))return m(e)}catch(t){console.warn("[AI Tools] Failed to parse stored tag pool, rebuilding...",t)}return[]})}function y(){return i(this,void 0,void 0,function*(){const t=yield p();return t.length?(yield n.default.settings.setValue(g,t.join("\n")),t):h()})}function h(){return i(this,void 0,void 0,function*(){const t=new Set;let e=1;for(;;){const o=yield n.default.data.get(["notes"],{fields:["id"],limit:50,page:e}),i=o.items;if(Array.isArray(i))for(const e of i){if(!e||!e.id)continue;const o=yield M(e.id);for(const e of o){const o="string"==typeof e.title?e.title.trim():"";o&&t.add(o)}}if(!o.has_more)break;e+=1}const o=m(Array.from(t));return yield function(t){return i(this,void 0,void 0,function*(){const e=m(t);yield n.default.settings.setValue(c,JSON.stringify(e)),yield n.default.settings.setValue(g,e.join("\n"))})}(o),o})}function v(t){return Array.isArray(t)&&t.length?t.slice(0,200):[]}function T(t,e,o,n,r={}){return i(this,void 0,void 0,function*(){return new Promise((d,u)=>{const c=`${t.replace(/\/+$/,"")}/chat/completions`,g=new l.URL(c),f="https:"===g.protocol?a:s,{stream:m=!0,model:p="deepseek-chat",systemMessage:y}=r,h=`req-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,v=Date.now();console.info("[AI Tools] LLM Request",{requestId:h,endpoint:c,model:p,stream:m,systemMessage:y,prompt:o,timestamp:(new Date).toISOString()});const T={hostname:g.hostname,port:g.port,path:`${g.pathname}${g.search||""}`,method:"POST",headers:{"Content-Type":"application/json",Accept:m?"text/event-stream":"application/json",Authorization:`Bearer ${e}`}},w=f.request(T,t=>{if(!t)return console.error("[AI Tools] LLM Error",{requestId:h,reason:"No response object"}),void u(new Error("No response received from server"));const e=t.statusCode||0;if(e<200||e>=300){let o="";return t.setEncoding("utf8"),t.on("data",t=>{o+=t}),void t.on("end",()=>{console.error("[AI Tools] LLM Error",{requestId:h,statusCode:e,errorData:o}),u(new Error(`API request failed: ${e} ${o}`))})}const o=(t.headers["content-type"]||"").toString();let r="",a="",s=!1;const l=t=>i(this,void 0,void 0,function*(){var e,o,i,a,l,d,u,c;const g=t.split(/\r?\n/);for(const t of g){const g=t.trim();if(!g.startsWith("data:"))continue;const f=g.slice(5).trim();if(f){if("[DONE]"===f)return void(s=!0);try{const t=JSON.parse(f),s=null!==(c=null!==(a=null===(i=null===(o=null===(e=null==t?void 0:t.choices)||void 0===e?void 0:e[0])||void 0===o?void 0:o.delta)||void 0===i?void 0:i.content)&&void 0!==a?a:null===(u=null===(d=null===(l=null==t?void 0:t.choices)||void 0===l?void 0:l[0])||void 0===d?void 0:d.message)||void 0===u?void 0:u.content)&&void 0!==c?c:"";s&&(r+=s,n&&(yield n(s)))}catch(t){console.warn("Failed to parse streaming chunk:",f,t)}}}});if(!o.includes("text/event-stream")){let e="";return t.setEncoding("utf8"),t.on("data",t=>{e+=t}),void t.on("end",()=>i(this,void 0,void 0,function*(){var t,o,i,a;try{const s=JSON.parse(e),l=null!==(a=null===(i=null===(o=null===(t=null==s?void 0:s.choices)||void 0===t?void 0:t[0])||void 0===o?void 0:o.message)||void 0===i?void 0:i.content)&&void 0!==a?a:"";l&&(r=l,n&&(yield n(l))),console.info("[AI Tools] LLM Response",{requestId:h,durationMs:Date.now()-v,length:r.length,raw:r}),d(r)}catch(t){console.error("[AI Tools] LLM Response Parse Error",{requestId:h,responseText:e,error:t.message}),u(new Error(`Failed to parse response: ${t.message}`))}}))}t.setEncoding("utf8");let c=Promise.resolve();const g=t=>{c=c.then(()=>i(this,void 0,void 0,function*(){a+=t;const e=a.split(/\r?\n\r?\n/);a=e.pop()||"";for(const t of e){if(s)break;yield l(t)}})).catch(t=>{s=!0,u(t),w.destroy()})};t.on("data",t=>{s||g(t)}),t.on("end",()=>{c.then(()=>i(this,void 0,void 0,function*(){!s&&a&&(yield l(a)),console.info("[AI Tools] LLM Response",{requestId:h,durationMs:Date.now()-v,length:r.length,raw:r}),d(r)})).catch(t=>{console.error("[AI Tools] LLM Response Error",{requestId:h,error:t.message}),u(t)})}),t.on("error",t=>{console.error("[AI Tools] LLM Stream Error",{requestId:h,error:t.message}),s=!0,u(t)})});w.on("error",t=>{console.error("[AI Tools] LLM Request Error",{requestId:h,error:t.message}),u(t)});const b=[];y&&b.push({role:"system",content:y}),b.push({role:"user",content:o});const S=JSON.stringify({model:p,stream:m,messages:b});w.write(S),w.end()})})}function w(t,e){return t?t.length<=e?t:t.slice(0,e):""}function b(t,e,o){let i="",n=[];const r=t.trim();if(!r)return{title:"",tags:[],raw:t};let a=r;const s=r.indexOf("{"),l=r.lastIndexOf("}");-1!==s&&-1!==l&&l>s&&(a=r.slice(s,l+1));try{const t=JSON.parse(a);i="string"==typeof t.title?t.title:"",Array.isArray(t.tags)&&(n=t.tags.map(t=>"string"==typeof t?t.trim():"").filter(t=>!!t))}catch(t){}const d=function(t,e){if(!t)return"";let o=t.split(/\r?\n/).map(t=>t.trim()).find(t=>t.length>0)||"";return o=o.replace(/^["'“”‘’\s]+/,"").replace(/["'“”‘’\s]+$/,""),o?(o.length>80&&(o=o.slice(0,80).trim()),"untitled"===o.toLowerCase()||o===e?"":o):""}(i||r,e),u=Number.isFinite(o)?Math.max(0,Math.floor(o)):0,c=u>0?n.slice(0,u):[];return{title:d,tags:Array.from(new Set(c)),raw:t}}function S(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function x(t){if(!t)return"";const e=String(t).replace(/\r\n/g,"\n").replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n").trim();if(!e)return"";const o=t=>t.replace(/\n{3,}/g,"\n\n").split("\n").map(t=>t.replace(/\s+$/g,"")).join("\n");if(e.includes("\n"))return o(e);const i=(t,e)=>t.replace(e,(t,e,o)=>0===o?e:`\n${e}`);let n=e;return n=i(n,/\s*(#+\s+)/g),n=i(n,/\s*((?:>+\s+))/g),n=i(n,/\s*((?:[-*+]\s+))/g),n=i(n,/\s*((?:\d+\.\s+))/g),n=i(n,/\s*(```)/g),o(n)}function I(t){return t?`<![CDATA[${t.replace(/]]>/g,"]]]]><![CDATA[>")}]]>`:"<![CDATA[]]>"}function A(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function M(t){return i(this,void 0,void 0,function*(){const e=[];let o=1;for(;;){const i=yield n.default.data.get(["notes",t,"tags"],{fields:["id","title"],limit:100,page:o}),r=i.items;if(r&&r.length&&e.push(...r),!i.has_more)break;o+=1}return e})}const C={};function P(t){return i(this,void 0,void 0,function*(){const e=t.trim(),o=e.toLowerCase();if(C[o])return C[o];let i=1;for(;;){const t=yield n.default.data.get(["tags"],{fields:["id","title"],limit:100,page:i}),e=t.items;if(e){const t=e.find(t=>t.title.toLowerCase()===o);if(t)return C[o]=t.id,t.id}if(!t.has_more)break;i+=1}const r=(yield n.default.data.post(["tags"],null,{title:e})).id;return C[o]=r,r})}function N(t,e){return i(this,void 0,void 0,function*(){const o=Array.from(new Set(e.map(t=>t.trim()).filter(t=>!!t))),i=new Map(o.map(t=>[t.toLowerCase(),t])),r=new Set(i.keys()),a=yield M(t),s=new Map(a.map(t=>[t.title.toLowerCase(),t]));let l=0;for(const e of a){const o=e.title.toLowerCase();r.has(o)||(yield n.default.data.delete(["tags",e.id,"notes",t]),l+=1)}let d=0;for(const[e,o]of i.entries()){if(s.has(e))continue;const i=yield P(o);yield n.default.data.post(["tags",i,"notes"],null,{id:t}),d+=1}return{added:d,removed:l,final:o.length?o:[]}})}function $(t){const e=Number(t);return!Number.isFinite(e)||e<=0?3:Math.max(1,Math.min(10,Math.floor(e)))}function L(t,e,o,i){const n=x(t)||d,r=x(e)||u,a=v(i),s=["<systemInstructions>","  <meta>","    <role>ai-tools</role>","    <purpose>generate-note-title-and-tags</purpose>","    <language>zh-CN</language>","    <version>1.0</version>","  </meta>",`  <titleGuidance>${I(n)}</titleGuidance>`,`  <tagGuidance>${I(r)}</tagGuidance>`,"  <reusePolicy>","    <item>优先从标签池中选择语义匹配的标签；仅在确无合适选项时创建新标签。</item>","  </reusePolicy>"];if(a.length){s.push("  <tagPool>");for(const t of a)s.push(`    <tag>${S(t)}</tag>`);s.push("  </tagPool>")}return s.push("  <output>",'    <format>{"title":"...","tags":["..."]}</format>',`    <tagLimit>${o}</tagLimit>`,"    <constraints>","      <item>Do not return anything outside the JSON object.</item>","      <item>Ensure tags are relevant, deduplicated, and trimmed.</item>","    </constraints>","  </output>","</systemInstructions>"),s.join("\n")}function B(t,e,o){const i=v(o),n=["<note>",`  <originalTitle>${S(t||"（无标题）")}</originalTitle>`,`  <body>${I(e)}</body>`];if(i.length){n.push("  <tagPoolSnapshot>");for(const t of i)n.push(`    <tag>${S(t)}</tag>`);n.push("  </tagPoolSnapshot>")}return n.push("</note>"),n.join("\n")}function F(t){return i(this,void 0,void 0,function*(){const e=yield M(t);for(const o of e)yield n.default.data.delete(["tags",o.id,"notes",t]);return e.length})}n.default.plugins.register({onStart:function(){return i(this,void 0,void 0,function*(){yield n.default.settings.registerSection("aiToolsSettings",{label:"AI Tools",iconName:"fas fa-robot"}),yield n.default.settings.registerSettings({baseUrl:{value:"https://api.deepseek.com/v1",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"Base URL",description:"OpenAI compatible API endpoint (e.g., https://api.deepseek.com/v1)"},apiKey:{value:"",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,secure:!0,label:"API Key",description:"Your API key for the service"},titleSystemPrompt:{value:d,type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"标题系统提示词",description:"可选 system prompt，用于指导模型生成标题（支持粘贴 Markdown）。"},tagSystemPrompt:{value:u,type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"标签系统提示词",description:"可选 system prompt，用于指导模型生成标签（支持粘贴 Markdown）。"},tagLimit:{value:3,type:r.SettingItemType.Int,section:"aiToolsSettings",public:!0,label:"标签数量上限",description:"生成标签的数量，范围 1-10。"},tagPoolPreview:{value:"",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,advanced:!0,label:"标签池阅览（只读）",description:"由插件自动维护，只供查看当前标签池和例。"},tagPoolStorage:{value:"[]",type:r.SettingItemType.String,section:"aiToolsSettings",public:!1,label:"Tag Pool Storage",description:"Internal storage for tag pool state."}}),yield y(),yield n.default.settings.onChange(t=>i(this,void 0,void 0,function*(){if(t&&Array.isArray(t.keys)&&t.keys.includes(g)&&!f){f=!0;try{const t=yield p();yield n.default.settings.setValue(g,t.join("\n"))}finally{f=!1}}}));const t=yield n.default.views.dialogs.create("aiPromptEditor");yield n.default.views.dialogs.setButtons(t,[{id:"ok",title:"保存"},{id:"cancel",title:"取消"}]),yield n.default.views.dialogs.setFitToContent(t,!0);const e=yield n.default.views.dialogs.create("aiTagPoolViewer");yield n.default.views.dialogs.setButtons(e,[{id:"close",title:"关闭"}]),yield n.default.views.dialogs.setFitToContent(e,!0),yield n.default.commands.register({name:"aiEditPrompts",label:"AI 编辑提示词",iconName:"fas fa-pen",execute:()=>i(this,void 0,void 0,function*(){var e,o;try{const i=String((yield n.default.settings.value("titleSystemPrompt"))||""),a=String((yield n.default.settings.value("tagSystemPrompt"))||""),s=function(t,e,o){return`\n\t\t<style>\n\t\t\t* { box-sizing: border-box; }\n\t\t\tbody { margin: 0; padding: 16px; min-width: 760px; max-width: 800px; }\n\t\t\t.ai-tools-wrapper { width: 100%; }\n\t\t\t.ai-tools-form { font-family: sans-serif; padding: 0; margin: 0; }\n\t\t\t.ai-tools-form label { font-weight: 600; display: block; margin: 12px 0 4px; }\n\t\t\t.ai-tools-form textarea { width: 100%; min-height: 200px; padding: 8px; font-family: monospace; overflow-y: auto; resize: vertical; border: 1px solid #ccc; border-radius: 4px; }\n\t\t\t.ai-tools-form input[type="number"] { width: 120px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }\n\t\t\t.ai-tools-hint { color: #666; font-size: 12px; margin: 4px 0 0 0; }\n\t\t</style>\n\t\t<div class="ai-tools-wrapper">\n\t\t\t<form name="promptForm" class="ai-tools-form">\n\t\t\t\t<label for="titlePrompt">标题系统提示词</label>\n\t\t\t\t<textarea id="titlePrompt" name="titlePrompt" spellcheck="false" data-autoresize="true">${A(t)}</textarea>\n\t\t\t\t<p class="ai-tools-hint">用于生成标题的 system prompt，可直接使用 Markdown 结构。</p>\n\n\t\t\t\t<label for="tagPrompt">标签系统提示词</label>\n\t\t\t\t<textarea id="tagPrompt" name="tagPrompt" spellcheck="false" data-autoresize="true">${A(e)}</textarea>\n\t\t\t\t<p class="ai-tools-hint">用于生成标签的 system prompt，支持多行文本，可手动调整高度。</p>\n\n\t\t\t\t<label for="tagLimit">标签数量上限</label>\n\t\t\t\t<input id="tagLimit" name="tagLimit" type="number" min="1" max="10" value="${Number.isFinite(o)?o:3}" />\n\t\t\t\t<p class="ai-tools-hint">支持 1-10 之间的整数，默认为 3。</p>\n\t\t\t</form>\n\t\t</div>\n\t\t<script>\n\t\t\t(function() {\n\t\t\t\tconst resizeIfNeeded = (el, { growOnly } = { growOnly: false }) => {\n\t\t\t\t\tif (!el) return;\n\t\t\t\t\tconst minHeight = 200;\n\t\t\t\t\tconst currentHeight = el.clientHeight;\n\t\t\t\t\tel.style.height = 'auto';\n\t\t\t\t\tconst needed = Math.max(minHeight, el.scrollHeight);\n\t\t\t\t\tif (!growOnly || needed > currentHeight) {\n\t\t\t\t\t\tel.style.height = needed + 'px';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tel.style.height = currentHeight + 'px';\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tconst apply = () => {\n\t\t\t\t\tconst targets = document.querySelectorAll('[data-autoresize="true"]');\n\t\t\t\t\ttargets.forEach((el) => {\n\t\t\t\t\t\tresizeIfNeeded(el);\n\t\t\t\t\t\tel.addEventListener('input', () => resizeIfNeeded(el, { growOnly: true }));\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tif (document.readyState === 'loading') {\n\t\t\t\t\tdocument.addEventListener('DOMContentLoaded', apply);\n\t\t\t\t} else {\n\t\t\t\t\tapply();\n\t\t\t\t}\n\t\t\t})();\n\t\t<\/script>\n\t`}(i,a,$(yield n.default.settings.value("tagLimit")));yield n.default.views.dialogs.setHtml(t,s);const l=yield n.default.views.dialogs.open(t);if(!l||"ok"!==l.id)return;const d=(l.formData||{}).promptForm||{},u=String(null!==(e=d.titlePrompt)&&void 0!==e?e:"").trim(),c=String(null!==(o=d.tagPrompt)&&void 0!==o?o:"").trim(),g=$(d.tagLimit);yield n.default.settings.setValue("titleSystemPrompt",u),yield n.default.settings.setValue("tagSystemPrompt",c),yield n.default.settings.setValue("tagLimit",g),yield n.default.views.dialogs.showToast({message:"提示词设置已保存。",type:r.ToastType.Success,duration:5e3})}catch(t){console.error("AI Prompt Editor error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.commands.register({name:"aiShowTagPool",label:"AI 查看标签池",iconName:"fas fa-tags",execute:()=>i(this,void 0,void 0,function*(){try{const t=function(t){const e=Array.isArray(t)?t:[],o=e.map(t=>`<li>${A(t)}</li>`).join("");return`\n\t\t<style>\n\t\t\tbody { margin: 0; padding: 16px; font-family: sans-serif; min-width: 480px; max-width: 560px; }\n\t\t\th1 { font-size: 18px; margin: 0 0 12px; }\n\t\t\t.tag-pool-summary { color: #555; margin-bottom: 12px; }\n\t\t\t.tag-pool-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 12px; background: #fafafa; }\n\t\t\t.tag-pool-container ul { list-style: none; margin: 0; padding: 0; }\n\t\t\t.tag-pool-container li { padding: 4px 0; border-bottom: 1px solid #eee; font-family: monospace; }\n\t\t\t.tag-pool-container li:last-child { border-bottom: none; }\n\t\t</style>\n\t\t<div>\n\t\t\t<h1>标签池</h1>\n\t\t\t<p class="tag-pool-summary">共 ${e.length} 个标签</p>\n\t\t\t<div class="tag-pool-container">\n\t\t\t\t<ul>${o||"<li>暂无标签</li>"}</ul>\n\t\t\t</div>\n\t\t</div>\n\t`}(yield h());yield n.default.views.dialogs.setHtml(e,t),yield n.default.views.dialogs.open(e)}catch(t){console.error("AI Tag Pool Viewer error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t instanceof Error?t.message:t}`)}})}),yield n.default.commands.register({name:"aiChatWithSelection",label:"AI Chat",iconName:"fas fa-robot",execute:()=>i(this,void 0,void 0,function*(){try{if(!(yield n.default.workspace.selectedNote()))return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const t=function(t){if("string"==typeof t)return t;if(!t)return"";if(Array.isArray(t))return t.filter(t=>"string"==typeof t).join("\n");if("object"==typeof t){const e=["text","value","html","plainText"];for(const o of e){const e=t[o];if("string"==typeof e)return e}}return""}(yield n.default.commands.execute("editor.execCommand",{name:"selectedText"}));if(!t||""===t.trim())return void(yield n.default.views.dialogs.showMessageBox("Please select some text first."));const e=yield n.default.settings.value("baseUrl"),o=yield n.default.settings.value("apiKey");if(!o||""===o.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const r="\n\n---\n**AI Response:**\n\n";yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[t+r]});let a="";const s=t=>i(this,void 0,void 0,function*(){t&&(a+=t,yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[t]}))});try{yield T(e,o,t,t=>i(this,void 0,void 0,function*(){yield s(t)}),{stream:!0}),a&&(yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:["\n"]}))}catch(t){const e=`\n[Error: ${t.message}]`;throw yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[e]}),t}}catch(t){console.error("AI Chat error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.commands.register({name:"aiGenerateTitleForCurrentNote",label:"AI Generate Title for Current Note",iconName:"fas fa-lightbulb",execute:()=>i(this,void 0,void 0,function*(){try{const t=yield n.default.workspace.selectedNote();if(!t)return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const e=yield n.default.settings.value("baseUrl"),o=yield n.default.settings.value("apiKey");if(!o||""===o.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const i=String((yield n.default.settings.value("titleSystemPrompt"))||""),a=String((yield n.default.settings.value("tagSystemPrompt"))||""),s=$(yield n.default.settings.value("tagLimit")),l=yield y(),d=L(i,a,s,l),u="string"==typeof t.body?t.body:"";if(!u.trim())return void(yield n.default.views.dialogs.showMessageBox("当前笔记内容为空，无法生成标题。"));const c=w(u,4e3),g=B(t.title||"（无标题）",c,l),f=b(yield T(e,o,g,void 0,{stream:!1,systemMessage:d}),t.title,s),m=!!f.title&&f.title!==t.title,p=f.tags.length>0;if(!m&&!p)return void(yield n.default.views.dialogs.showMessageBox("AI 未生成有效的标题或标签。"));m&&(yield n.default.data.put(["notes",t.id],null,{title:f.title}));let v={added:0,removed:0,final:[]};p&&(v=yield N(t.id,f.tags),(v.added||v.removed)&&(yield h()));const S=[];if(m&&S.push(`标题已更新为「${f.title}」`),p&&(v.added||v.removed||v.final.length)){const t=[];v.final.length&&t.push(`标签：${v.final.join(", ")}`),v.added&&t.push(`新增 ${v.added}`),v.removed&&t.push(`移除 ${v.removed}`),S.push(t.join("，"))}yield n.default.views.dialogs.showToast({message:S.join("；")||"AI 已更新当前笔记。",type:r.ToastType.Success,duration:5e3})}catch(t){console.error("AI Generate Title (current note) error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.commands.register({name:"aiClearTagsForCurrentNote",label:"AI Clear Tags for Current Note",iconName:"fas fa-eraser",execute:()=>i(this,void 0,void 0,function*(){try{const t=yield n.default.workspace.selectedNote();if(!t)return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const e=yield F(t.id);e>0&&(yield h()),yield n.default.views.dialogs.showToast({message:e?`已移除当前笔记的 ${e} 个标签。`:"当前笔记没有可移除的标签。",type:r.ToastType.Info,duration:4e3})}catch(t){console.error("AI Clear Tags (current note) error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.commands.register({name:"aiGenerateTitlesForAllNotes",label:"AI Generate Titles for All Notes",iconName:"fas fa-clipboard-list",execute:()=>i(this,void 0,void 0,function*(){try{const t=yield n.default.settings.value("baseUrl"),e=yield n.default.settings.value("apiKey");if(!e||""===e.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const o=String((yield n.default.settings.value("titleSystemPrompt"))||""),i=String((yield n.default.settings.value("tagSystemPrompt"))||""),a=$(yield n.default.settings.value("tagLimit")),s=yield y(),l=new Set(s),d=20;let u=1,c=0,g=0,f=0,m=0,p=0,v=0,S=!1;const x=[],I=[];for(;;){const r=yield n.default.data.get(["notes"],{fields:["id","title","body"],limit:d,page:u}),s=r.items||[];if(!s.length)break;for(const r of s){c++;const s="string"==typeof r.body?r.body:"";if(!s.trim()){I.push(r.id);continue}const d=w(s,4e3),u=Array.from(l),y=L(o,i,a,u),h=B(r.title||"（无标题）",d,u);try{const o=b(yield T(t,e,h,void 0,{stream:!1,systemMessage:y}),r.title,a),i=!!o.title&&o.title!==r.title,s=o.tags.length>0;if(!i&&!s){I.push(r.id);continue}let d=!1;i&&(yield n.default.data.put(["notes",r.id],null,{title:o.title}),d=!0,g++);let u=!1;if(s){const t=yield N(r.id,o.tags);if(Array.isArray(t.final)&&t.final.length)for(const e of t.final)l.add(e);(t.added||t.removed)&&(u=!0,S=!0),t.added&&(p+=t.added),t.removed&&(v+=t.removed),(t.added||t.removed)&&(m+=1)}d||u?(d||g++,d&&(f+=1)):I.push(r.id)}catch(t){const e=t instanceof Error?t.message:`${t}`;x.push(`${r.id}: ${e}`),console.error(`Failed to update title for note ${r.id}:`,t)}}if(!r.has_more)break;u+=1}S?yield h():yield y();const A=[`Processed: ${c}`,`Updated Notes: ${g}`,`Titles Updated: ${f}`,`Tag Adjustments: ${m} (+${p}/-${v})`,`Skipped: ${I.length}`,x.length?`Errors: ${x.length}`:""].filter(Boolean).join(", ");console.info(`AI title generation summary: ${A}`);const M=x.length?`AI 批量更新完成：标题 ${f}，标签 ${m}，跳过 ${I.length}，错误 ${x.length}`:`AI 批量更新完成：标题 ${f}，标签 ${m}，跳过 ${I.length}`;yield n.default.views.dialogs.showToast({message:M,type:x.length?r.ToastType.Info:r.ToastType.Success,duration:8e3})}catch(t){console.error("AI Generate Titles error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.commands.register({name:"aiClearTagsForAllNotes",label:"AI Clear Tags for All Notes",iconName:"fas fa-broom",execute:()=>i(this,void 0,void 0,function*(){try{const t=50;let e=1,o=0,i=0,a=0;for(;;){const r=yield n.default.data.get(["notes"],{fields:["id","title"],limit:t,page:e}),s=r.items||[];if(!s.length)break;for(const t of s){o++;const e=yield F(t.id);e>0&&(i++,a+=e)}if(!r.has_more)break;e+=1}console.info(`AI clear tags summary: processed ${o}, cleared ${i}, tags removed ${a}`),a>0?yield h():yield y(),yield n.default.views.dialogs.showToast({message:a?`已从 ${i} 篇笔记移除 ${a} 个标签。`:"所有笔记均无可移除的标签。",type:a?r.ToastType.Success:r.ToastType.Info,duration:6e3})}catch(t){console.error("AI Clear Tags (all notes) error:",t),yield n.default.views.dialogs.showMessageBox(`Error: ${t.message}`)}})}),yield n.default.views.toolbarButtons.create("aiChatButton","aiChatWithSelection",r.ToolbarButtonLocation.EditorToolbar),yield n.default.views.toolbarButtons.create("aiGenerateTitleCurrentButton","aiGenerateTitleForCurrentNote",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiClearTagsCurrentButton","aiClearTagsForCurrentNote",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiGenerateTitlesButton","aiGenerateTitlesForAllNotes",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiClearTagsAllButton","aiClearTagsForAllNotes",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.menus.create("aiToolsMenu","AI Tools",[{commandName:"aiEditPrompts"},{commandName:"aiShowTagPool"},{commandName:"aiGenerateTitleForCurrentNote"},{commandName:"aiClearTagsForCurrentNote"},{commandName:"aiGenerateTitlesForAllNotes",accelerator:"CmdOrCtrl+Shift+T"},{commandName:"aiClearTagsForAllNotes"}],r.MenuItemLocation.Tools),console.info("AI Tools plugin started!")})}})},611:t=>{t.exports=require("http")},692:t=>{t.exports=require("https")},998:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=joplin}},e={};!function o(i){var n=e[i];if(void 0!==n)return n.exports;var r=e[i]={exports:{}};return t[i].call(r.exports,r,r.exports,o),r.exports}(156)})();