(()=>{"use strict";var e={16:e=>{e.exports=require("url")},143:(e,t)=>{var o,i,n,r,s,a,l,d,u,c,f;Object.defineProperty(t,"__esModule",{value:!0}),t.ContentScriptType=t.SettingStorage=t.AppType=t.SettingItemSubType=t.SettingItemType=t.ToastType=t.ToolbarButtonLocation=t.isContextMenuItemLocation=t.MenuItemLocation=t.ModelType=t.ImportModuleOutputFormat=t.FileSystemItem=void 0,(f=t.FileSystemItem||(t.FileSystemItem={})).File="file",f.Directory="directory",(c=t.ImportModuleOutputFormat||(t.ImportModuleOutputFormat={})).Markdown="md",c.Html="html",(u=t.ModelType||(t.ModelType={}))[u.Note=1]="Note",u[u.Folder=2]="Folder",u[u.Setting=3]="Setting",u[u.Resource=4]="Resource",u[u.Tag=5]="Tag",u[u.NoteTag=6]="NoteTag",u[u.Search=7]="Search",u[u.Alarm=8]="Alarm",u[u.MasterKey=9]="MasterKey",u[u.ItemChange=10]="ItemChange",u[u.NoteResource=11]="NoteResource",u[u.ResourceLocalState=12]="ResourceLocalState",u[u.Revision=13]="Revision",u[u.Migration=14]="Migration",u[u.SmartFilter=15]="SmartFilter",u[u.Command=16]="Command",function(e){e.File="file",e.Edit="edit",e.View="view",e.Note="note",e.Tools="tools",e.Help="help",e.Context="context",e.NoteListContextMenu="noteListContextMenu",e.EditorContextMenu="editorContextMenu",e.FolderContextMenu="folderContextMenu",e.TagContextMenu="tagContextMenu"}(o=t.MenuItemLocation||(t.MenuItemLocation={})),t.isContextMenuItemLocation=function(e){return[o.Context,o.NoteListContextMenu,o.EditorContextMenu,o.FolderContextMenu,o.TagContextMenu].includes(e)},(d=t.ToolbarButtonLocation||(t.ToolbarButtonLocation={})).NoteToolbar="noteToolbar",d.EditorToolbar="editorToolbar",(l=t.ToastType||(t.ToastType={})).Info="info",l.Success="success",l.Error="error",(a=t.SettingItemType||(t.SettingItemType={}))[a.Int=1]="Int",a[a.String=2]="String",a[a.Bool=3]="Bool",a[a.Array=4]="Array",a[a.Object=5]="Object",a[a.Button=6]="Button",(s=t.SettingItemSubType||(t.SettingItemSubType={})).FilePathAndArgs="file_path_and_args",s.FilePath="file_path",s.DirectoryPath="directory_path",(r=t.AppType||(t.AppType={})).Desktop="desktop",r.Mobile="mobile",r.Cli="cli",(n=t.SettingStorage||(t.SettingStorage={}))[n.Database=1]="Database",n[n.File=2]="File",(i=t.ContentScriptType||(t.ContentScriptType={})).MarkdownItPlugin="markdownItPlugin",i.CodeMirrorPlugin="codeMirrorPlugin"},156:function(e,t,o){var i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))(function(n,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(s,a)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=o(998),r=o(143),s=o(692),a=o(611),l=o(16),d="你是一名知识管理助手，需根据笔记内容生成简洁、具体的中文标题。",u=["# 角色","你是一名严格的原子标签生成器。","","# 背景","用户需要从笔记内容中提炼出最基础的、不可再分的概念标签，以便后续灵活组合和检索。标签必须代表独立的语义单元。","","# 核心指令","## 三条强制规则","1. **首要实体原则**","    第一个标签必须是笔记讨论的**最核心、最具体的实体**（如软件名、项目名、特定概念）。这是唯一允许使用的专有名词标签。","","2. **绝对拆解规则**","    严禁生成任何复合标签。以下情况必须拆解：","    - 包含“的”字结构（如“数据的备份” → `数据, 备份`）","    - 由两个独立名词拼接（如“数据管理” → `数据, 管理`）","    - 由名词+动词/动名词拼接（如“格式转换” → `格式, 转换`）","","3. **词性纯净要求**","    所有标签必须是：","    - 单一概念的名词（如`Python`）","    - 或明确的动名词（如`备份`、`迁移`）","","# 操作流程","1. **锁定核心**：识别笔记中最具体的实体作为第一个标签","2. **拆解提炼**：提取其他基础动作、属性和领域概念，彻底拆解所有复合词","3. **纯净检查**：确保每个标签都是原子概念，且彼此语义独立"].join("\n"),c="tagPoolStorage",f="tagPoolPreview";let g=!1;function m(e){const t=new Set;for(const o of e){const e="string"==typeof o?o.trim():"";e&&t.add(e)}return Array.from(t).sort((e,t)=>e.localeCompare(t,"zh-Hans-CN",{sensitivity:"base"}))}function p(){return i(this,void 0,void 0,function*(){const e=yield n.default.settings.value(c);if("string"!=typeof e||!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return m(t)}catch(e){console.warn("[AI Tools] Failed to parse stored tag pool, rebuilding...",e)}return[]})}function y(){return i(this,void 0,void 0,function*(){const e=yield p();return e.length?(yield n.default.settings.setValue(f,e.join("\n")),e):h()})}function h(){return i(this,void 0,void 0,function*(){const e=new Set;let t=1;for(;;){const o=yield n.default.data.get(["notes"],{fields:["id"],limit:50,page:t}),i=o.items;if(Array.isArray(i))for(const t of i){if(!t||!t.id)continue;const o=yield $(t.id);for(const t of o){const o="string"==typeof t.title?t.title.trim():"";o&&e.add(o)}}if(!o.has_more)break;t+=1}const o=m(Array.from(e));return yield function(e){return i(this,void 0,void 0,function*(){const t=m(e);yield n.default.settings.setValue(c,JSON.stringify(t)),yield n.default.settings.setValue(f,t.join("\n"))})}(o),o})}function v(e){return Array.isArray(e)&&e.length?e.slice(0,200):[]}function T(e,t,o,n,r={}){return i(this,void 0,void 0,function*(){return new Promise((d,u)=>{const c=`${e.replace(/\/+$/,"")}/chat/completions`,f=new l.URL(c),g="https:"===f.protocol?s:a,{stream:m=!0,model:p="deepseek-chat",systemMessage:y}=r,h=`req-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,v=Date.now();console.info("[AI Tools] LLM Request",{requestId:h,endpoint:c,model:p,stream:m,systemMessage:y,prompt:o,timestamp:(new Date).toISOString()});const T={hostname:f.hostname,port:f.port,path:`${f.pathname}${f.search||""}`,method:"POST",headers:{"Content-Type":"application/json",Accept:m?"text/event-stream":"application/json",Authorization:`Bearer ${t}`}},b=g.request(T,e=>{if(!e)return console.error("[AI Tools] LLM Error",{requestId:h,reason:"No response object"}),void u(new Error("No response received from server"));const t=e.statusCode||0;if(t<200||t>=300){let o="";return e.setEncoding("utf8"),e.on("data",e=>{o+=e}),void e.on("end",()=>{console.error("[AI Tools] LLM Error",{requestId:h,statusCode:t,errorData:o}),u(new Error(`API request failed: ${t} ${o}`))})}const o=(e.headers["content-type"]||"").toString();let r="",s="",a=!1;const l=e=>i(this,void 0,void 0,function*(){var t,o,i,s,l,d,u,c;const f=e.split(/\r?\n/);for(const e of f){const f=e.trim();if(!f.startsWith("data:"))continue;const g=f.slice(5).trim();if(g){if("[DONE]"===g)return void(a=!0);try{const e=JSON.parse(g),a=null!==(c=null!==(s=null===(i=null===(o=null===(t=null==e?void 0:e.choices)||void 0===t?void 0:t[0])||void 0===o?void 0:o.delta)||void 0===i?void 0:i.content)&&void 0!==s?s:null===(u=null===(d=null===(l=null==e?void 0:e.choices)||void 0===l?void 0:l[0])||void 0===d?void 0:d.message)||void 0===u?void 0:u.content)&&void 0!==c?c:"";a&&(r+=a,n&&(yield n(a)))}catch(e){console.warn("Failed to parse streaming chunk:",g,e)}}}});if(!o.includes("text/event-stream")){let t="";return e.setEncoding("utf8"),e.on("data",e=>{t+=e}),void e.on("end",()=>i(this,void 0,void 0,function*(){var e,o,i,s;try{const a=JSON.parse(t),l=null!==(s=null===(i=null===(o=null===(e=null==a?void 0:a.choices)||void 0===e?void 0:e[0])||void 0===o?void 0:o.message)||void 0===i?void 0:i.content)&&void 0!==s?s:"";l&&(r=l,n&&(yield n(l))),console.info("[AI Tools] LLM Response",{requestId:h,durationMs:Date.now()-v,length:r.length,raw:r}),d(r)}catch(e){console.error("[AI Tools] LLM Response Parse Error",{requestId:h,responseText:t,error:e.message}),u(new Error(`Failed to parse response: ${e.message}`))}}))}e.setEncoding("utf8");let c=Promise.resolve();const f=e=>{c=c.then(()=>i(this,void 0,void 0,function*(){s+=e;const t=s.split(/\r?\n\r?\n/);s=t.pop()||"";for(const e of t){if(a)break;yield l(e)}})).catch(e=>{a=!0,u(e),b.destroy()})};e.on("data",e=>{a||f(e)}),e.on("end",()=>{c.then(()=>i(this,void 0,void 0,function*(){!a&&s&&(yield l(s)),console.info("[AI Tools] LLM Response",{requestId:h,durationMs:Date.now()-v,length:r.length,raw:r}),d(r)})).catch(e=>{console.error("[AI Tools] LLM Response Error",{requestId:h,error:e.message}),u(e)})}),e.on("error",e=>{console.error("[AI Tools] LLM Stream Error",{requestId:h,error:e.message}),a=!0,u(e)})});b.on("error",e=>{console.error("[AI Tools] LLM Request Error",{requestId:h,error:e.message}),u(e)});const w=[];y&&w.push({role:"system",content:y}),w.push({role:"user",content:o});const S=JSON.stringify({model:p,stream:m,messages:w});b.write(S),b.end()})})}function b(e,t){return e?e.length<=t?e:e.slice(0,t):""}function w(e,t,o){let i="",n=[];const r=e.trim();if(!r)return{title:"",tags:[],raw:e};let s=r;const a=r.indexOf("{"),l=r.lastIndexOf("}");-1!==a&&-1!==l&&l>a&&(s=r.slice(a,l+1));try{const e=JSON.parse(s);i="string"==typeof e.title?e.title:"",Array.isArray(e.tags)&&(n=e.tags.map(e=>"string"==typeof e?e.trim():"").filter(e=>!!e))}catch(e){}const d=function(e,t){if(!e)return"";let o=e.split(/\r?\n/).map(e=>e.trim()).find(e=>e.length>0)||"";return o=o.replace(/^["'“”‘’\s]+/,"").replace(/["'“”‘’\s]+$/,""),o?(o.length>80&&(o=o.slice(0,80).trim()),"untitled"===o.toLowerCase()||o===t?"":o):""}(i||r,t),u=Number.isFinite(o)?Math.max(0,Math.floor(o)):0,c=u>0?n.slice(0,u):[];return{title:d,tags:Array.from(new Set(c)),raw:e}}function S(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function x(e){if(!e)return"";const t=String(e).replace(/\r\n/g,"\n").replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n").trim();if(!t)return"";const o=e=>e.replace(/\n{3,}/g,"\n\n").split("\n").map(e=>e.replace(/\s+$/g,"")).join("\n");if(t.includes("\n"))return o(t);const i=(e,t)=>e.replace(t,(e,t,o)=>0===o?t:`\n${t}`);let n=t;return n=i(n,/\s*(#+\s+)/g),n=i(n,/\s*((?:>+\s+))/g),n=i(n,/\s*((?:[-*+]\s+))/g),n=i(n,/\s*((?:\d+\.\s+))/g),n=i(n,/\s*(```)/g),o(n)}function A(e){return e?`<![CDATA[${e.replace(/]]>/g,"]]]]><![CDATA[>")}]]>`:"<![CDATA[]]>"}function I(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function $(e){return i(this,void 0,void 0,function*(){const t=[];let o=1;for(;;){const i=yield n.default.data.get(["notes",e,"tags"],{fields:["id","title"],limit:100,page:o}),r=i.items;if(r&&r.length&&t.push(...r),!i.has_more)break;o+=1}return t})}const C={};function M(e){return i(this,void 0,void 0,function*(){const t=e.trim(),o=t.toLowerCase();if(C[o])return C[o];let i=1;for(;;){const e=yield n.default.data.get(["tags"],{fields:["id","title"],limit:100,page:i}),t=e.items;if(t){const e=t.find(e=>e.title.toLowerCase()===o);if(e)return C[o]=e.id,e.id}if(!e.has_more)break;i+=1}const r=(yield n.default.data.post(["tags"],null,{title:t})).id;return C[o]=r,r})}function N(e,t){return i(this,void 0,void 0,function*(){const o=Array.from(new Set(t.map(e=>e.trim()).filter(e=>!!e))),i=new Map(o.map(e=>[e.toLowerCase(),e])),r=new Set(i.keys()),s=yield $(e),a=new Map(s.map(e=>[e.title.toLowerCase(),e]));let l=0;for(const t of s){const o=t.title.toLowerCase();r.has(o)||(yield n.default.data.delete(["tags",t.id,"notes",e]),l+=1)}let d=0;for(const[t,o]of i.entries()){if(a.has(t))continue;const i=yield M(o);yield n.default.data.post(["tags",i,"notes"],null,{id:e}),d+=1}return{added:d,removed:l,final:o.length?o:[]}})}function P(e){const t=Number(e);return!Number.isFinite(t)||t<=0?3:Math.max(1,Math.min(10,Math.floor(t)))}function L(e,t,o,i){const n=x(e)||d,r=x(t)||u,s=v(i),a=["<systemInstructions>","  <meta>","    <role>ai-tools</role>","    <purpose>generate-note-title-and-tags</purpose>","    <language>zh-CN</language>","    <version>1.0</version>","  </meta>",`  <titleGuidance>${A(n)}</titleGuidance>`,`  <tagGuidance>${A(r)}</tagGuidance>`,"  <reusePolicy>","    <item>优先从标签池中选择语义匹配的标签；仅在确无合适选项时创建新标签。</item>","  </reusePolicy>"];if(s.length){a.push("  <tagPool>");for(const e of s)a.push(`    <tag>${S(e)}</tag>`);a.push("  </tagPool>")}return a.push("  <output>",'    <format>{"title":"...","tags":["..."]}</format>',`    <tagLimit>${o}</tagLimit>`,"    <constraints>","      <item>Do not return anything outside the JSON object.</item>","      <item>Ensure tags are relevant, deduplicated, and trimmed.</item>","    </constraints>","  </output>","</systemInstructions>"),a.join("\n")}function k(e,t,o){const i=v(o),n=["<note>",`  <originalTitle>${S(e||"（无标题）")}</originalTitle>`,`  <body>${A(t)}</body>`];if(i.length){n.push("  <tagPoolSnapshot>");for(const e of i)n.push(`    <tag>${S(e)}</tag>`);n.push("  </tagPoolSnapshot>")}return n.push("</note>"),n.join("\n")}function B(e){return i(this,void 0,void 0,function*(){const t=yield $(e);for(const o of t)yield n.default.data.delete(["tags",o.id,"notes",e]);return t.length})}function F(){return i(this,void 0,void 0,function*(){const e=(e,t)=>i(this,void 0,void 0,function*(){var o;if("string"!=typeof e||!e)return null;try{const i=yield n.default.data.get(["folders",e],{fields:["id","title"]});if(i&&"string"==typeof i.id&&i.id)return{id:i.id,title:null!==(o=i.title)&&void 0!==o?o:t}}catch(t){console.warn(`[AI Tools] Failed to verify folder ${e}`,t)}return null});try{const t=yield n.default.workspace.selectedFolder(),o=yield e(null==t?void 0:t.id,null==t?void 0:t.title);if(o)return o}catch(e){console.warn("[AI Tools] Failed to read selected folder",e)}try{const t=yield n.default.workspace.selectedNote();if(t){const o=yield e(t.parent_id);if(o)return o}}catch(e){console.warn("[AI Tools] Failed to read selected note",e)}return null})}function E(e,t,o,r){return i(this,void 0,void 0,function*(){const s=yield function(e){return i(this,void 0,void 0,function*(){const t=[],o=[],i=new Set;try{const t=yield n.default.data.get(["folders",e],{fields:["id"]});if(!t||"string"!=typeof t.id)return[];o.push(t.id)}catch(t){return console.warn(`[AI Tools] Failed to load root folder ${e}`,t),[]}for(;o.length;){const e=o.pop();if(!e||i.has(e))continue;i.add(e),t.push(e);let r=1;for(;;){let t=null;try{t=yield n.default.data.get(["folders",e,"folders"],{fields:["id"],limit:50,page:r})}catch(t){console.warn(`[AI Tools] Failed to load sub-folders for ${e}`,t);break}const s=null==t?void 0:t.items;if(Array.isArray(s))for(const e of s)e&&"string"==typeof e.id&&e.id&&!i.has(e.id)&&o.push(e.id);if(!(null==t?void 0:t.has_more))break;r+=1}}return t})}(e);if(s.length)for(const e of s){let i=1;for(;;){let s=null;try{s=yield n.default.data.get(["folders",e,"notes"],{fields:t,limit:o,page:i})}catch(t){console.warn(`[AI Tools] Failed to load notes for folder ${e}`,t);break}const a=null==s?void 0:s.items;if(Array.isArray(a)&&a.length)for(const e of a)yield r(e);if(!(null==s?void 0:s.has_more))break;i+=1}}})}n.default.plugins.register({onStart:function(){return i(this,void 0,void 0,function*(){yield n.default.settings.registerSection("aiToolsSettings",{label:"AI Tools",iconName:"fas fa-robot"}),yield n.default.settings.registerSettings({baseUrl:{value:"https://api.deepseek.com/v1",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"Base URL",description:"OpenAI compatible API endpoint (e.g., https://api.deepseek.com/v1)"},apiKey:{value:"",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,secure:!0,label:"API Key",description:"Your API key for the service"},titleSystemPrompt:{value:d,type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"标题系统提示词",description:"可选 system prompt，用于指导模型生成标题（支持粘贴 Markdown）。"},tagSystemPrompt:{value:u,type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,label:"标签系统提示词",description:"可选 system prompt，用于指导模型生成标签（支持粘贴 Markdown）。"},tagLimit:{value:3,type:r.SettingItemType.Int,section:"aiToolsSettings",public:!0,label:"标签数量上限",description:"生成标签的数量，范围 1-10。"},tagPoolPreview:{value:"",type:r.SettingItemType.String,section:"aiToolsSettings",public:!0,advanced:!0,label:"标签池阅览（只读）",description:"由插件自动维护，只供查看当前标签池和例。"},tagPoolStorage:{value:"[]",type:r.SettingItemType.String,section:"aiToolsSettings",public:!1,label:"Tag Pool Storage",description:"Internal storage for tag pool state."}}),yield y(),yield n.default.settings.onChange(e=>i(this,void 0,void 0,function*(){if(e&&Array.isArray(e.keys)&&e.keys.includes(f)&&!g){g=!0;try{const e=yield p();yield n.default.settings.setValue(f,e.join("\n"))}finally{g=!1}}}));const e=yield n.default.views.dialogs.create("aiPromptEditor");yield n.default.views.dialogs.setButtons(e,[{id:"ok",title:"保存"},{id:"cancel",title:"取消"}]),yield n.default.views.dialogs.setFitToContent(e,!0);const t=yield n.default.views.dialogs.create("aiTagPoolViewer");yield n.default.views.dialogs.setButtons(t,[{id:"close",title:"关闭"}]),yield n.default.views.dialogs.setFitToContent(t,!0),yield n.default.commands.register({name:"aiEditPrompts",label:"AI 编辑提示词",iconName:"fas fa-pen",execute:()=>i(this,void 0,void 0,function*(){var t,o;try{const i=String((yield n.default.settings.value("titleSystemPrompt"))||""),s=String((yield n.default.settings.value("tagSystemPrompt"))||""),a=function(e,t,o){return`\n\t\t<style>\n\t\t\t* { box-sizing: border-box; }\n\t\t\tbody { margin: 0; padding: 16px; min-width: 760px; max-width: 800px; }\n\t\t\t.ai-tools-wrapper { width: 100%; }\n\t\t\t.ai-tools-form { font-family: sans-serif; padding: 0; margin: 0; }\n\t\t\t.ai-tools-form label { font-weight: 600; display: block; margin: 12px 0 4px; }\n\t\t\t.ai-tools-form textarea { width: 100%; min-height: 200px; padding: 8px; font-family: monospace; overflow-y: auto; resize: vertical; border: 1px solid #ccc; border-radius: 4px; }\n\t\t\t.ai-tools-form input[type="number"] { width: 120px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }\n\t\t\t.ai-tools-hint { color: #666; font-size: 12px; margin: 4px 0 0 0; }\n\t\t</style>\n\t\t<div class="ai-tools-wrapper">\n\t\t\t<form name="promptForm" class="ai-tools-form">\n\t\t\t\t<label for="titlePrompt">标题系统提示词</label>\n\t\t\t\t<textarea id="titlePrompt" name="titlePrompt" spellcheck="false" data-autoresize="true">${I(e)}</textarea>\n\t\t\t\t<p class="ai-tools-hint">用于生成标题的 system prompt，可直接使用 Markdown 结构。</p>\n\n\t\t\t\t<label for="tagPrompt">标签系统提示词</label>\n\t\t\t\t<textarea id="tagPrompt" name="tagPrompt" spellcheck="false" data-autoresize="true">${I(t)}</textarea>\n\t\t\t\t<p class="ai-tools-hint">用于生成标签的 system prompt，支持多行文本，可手动调整高度。</p>\n\n\t\t\t\t<label for="tagLimit">标签数量上限</label>\n\t\t\t\t<input id="tagLimit" name="tagLimit" type="number" min="1" max="10" value="${Number.isFinite(o)?o:3}" />\n\t\t\t\t<p class="ai-tools-hint">支持 1-10 之间的整数，默认为 3。</p>\n\t\t\t</form>\n\t\t</div>\n\t\t<script>\n\t\t\t(function() {\n\t\t\t\tconst resizeIfNeeded = (el, { growOnly } = { growOnly: false }) => {\n\t\t\t\t\tif (!el) return;\n\t\t\t\t\tconst minHeight = 200;\n\t\t\t\t\tconst currentHeight = el.clientHeight;\n\t\t\t\t\tel.style.height = 'auto';\n\t\t\t\t\tconst needed = Math.max(minHeight, el.scrollHeight);\n\t\t\t\t\tif (!growOnly || needed > currentHeight) {\n\t\t\t\t\t\tel.style.height = needed + 'px';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tel.style.height = currentHeight + 'px';\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tconst apply = () => {\n\t\t\t\t\tconst targets = document.querySelectorAll('[data-autoresize="true"]');\n\t\t\t\t\ttargets.forEach((el) => {\n\t\t\t\t\t\tresizeIfNeeded(el);\n\t\t\t\t\t\tel.addEventListener('input', () => resizeIfNeeded(el, { growOnly: true }));\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tif (document.readyState === 'loading') {\n\t\t\t\t\tdocument.addEventListener('DOMContentLoaded', apply);\n\t\t\t\t} else {\n\t\t\t\t\tapply();\n\t\t\t\t}\n\t\t\t})();\n\t\t<\/script>\n\t`}(i,s,P(yield n.default.settings.value("tagLimit")));yield n.default.views.dialogs.setHtml(e,a);const l=yield n.default.views.dialogs.open(e);if(!l||"ok"!==l.id)return;const d=(l.formData||{}).promptForm||{},u=String(null!==(t=d.titlePrompt)&&void 0!==t?t:"").trim(),c=String(null!==(o=d.tagPrompt)&&void 0!==o?o:"").trim(),f=P(d.tagLimit);yield n.default.settings.setValue("titleSystemPrompt",u),yield n.default.settings.setValue("tagSystemPrompt",c),yield n.default.settings.setValue("tagLimit",f),yield n.default.views.dialogs.showToast({message:"提示词设置已保存。",type:r.ToastType.Success,duration:5e3})}catch(e){console.error("AI Prompt Editor error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiShowTagPool",label:"AI 查看标签池",iconName:"fas fa-tags",execute:()=>i(this,void 0,void 0,function*(){try{const e=function(e){const t=Array.isArray(e)?e:[],o=t.map(e=>`<li>${I(e)}</li>`).join("");return`\n\t\t<style>\n\t\t\tbody { margin: 0; padding: 16px; font-family: sans-serif; min-width: 480px; max-width: 560px; }\n\t\t\th1 { font-size: 18px; margin: 0 0 12px; }\n\t\t\t.tag-pool-summary { color: #555; margin-bottom: 12px; }\n\t\t\t.tag-pool-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 12px; background: #fafafa; }\n\t\t\t.tag-pool-container ul { list-style: none; margin: 0; padding: 0; }\n\t\t\t.tag-pool-container li { padding: 4px 0; border-bottom: 1px solid #eee; font-family: monospace; }\n\t\t\t.tag-pool-container li:last-child { border-bottom: none; }\n\t\t</style>\n\t\t<div>\n\t\t\t<h1>标签池</h1>\n\t\t\t<p class="tag-pool-summary">共 ${t.length} 个标签</p>\n\t\t\t<div class="tag-pool-container">\n\t\t\t\t<ul>${o||"<li>暂无标签</li>"}</ul>\n\t\t\t</div>\n\t\t</div>\n\t`}(yield h());yield n.default.views.dialogs.setHtml(t,e),yield n.default.views.dialogs.open(t)}catch(e){console.error("AI Tag Pool Viewer error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e instanceof Error?e.message:e}`)}})}),yield n.default.commands.register({name:"aiChatWithSelection",label:"AI Chat",iconName:"fas fa-robot",execute:()=>i(this,void 0,void 0,function*(){try{if(!(yield n.default.workspace.selectedNote()))return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const e=function(e){if("string"==typeof e)return e;if(!e)return"";if(Array.isArray(e))return e.filter(e=>"string"==typeof e).join("\n");if("object"==typeof e){const t=["text","value","html","plainText"];for(const o of t){const t=e[o];if("string"==typeof t)return t}}return""}(yield n.default.commands.execute("editor.execCommand",{name:"selectedText"}));if(!e||""===e.trim())return void(yield n.default.views.dialogs.showMessageBox("Please select some text first."));const t=yield n.default.settings.value("baseUrl"),o=yield n.default.settings.value("apiKey");if(!o||""===o.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const r="\n\n---\n**AI Response:**\n\n";yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[e+r]});let s="";const a=e=>i(this,void 0,void 0,function*(){e&&(s+=e,yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[e]}))});try{yield T(t,o,e,e=>i(this,void 0,void 0,function*(){yield a(e)}),{stream:!0}),s&&(yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:["\n"]}))}catch(e){const t=`\n[Error: ${e.message}]`;throw yield n.default.commands.execute("editor.execCommand",{name:"replaceSelection",args:[t]}),e}}catch(e){console.error("AI Chat error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiGenerateTitleForCurrentNote",label:"AI Generate Title for Current Note",iconName:"fas fa-lightbulb",execute:()=>i(this,void 0,void 0,function*(){try{const e=yield n.default.workspace.selectedNote();if(!e)return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const t=yield n.default.settings.value("baseUrl"),o=yield n.default.settings.value("apiKey");if(!o||""===o.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const i=String((yield n.default.settings.value("titleSystemPrompt"))||""),s=String((yield n.default.settings.value("tagSystemPrompt"))||""),a=P(yield n.default.settings.value("tagLimit")),l=yield y(),d=L(i,s,a,l),u="string"==typeof e.body?e.body:"";if(!u.trim())return void(yield n.default.views.dialogs.showMessageBox("当前笔记内容为空，无法生成标题。"));const c=b(u,4e3),f=k(e.title||"（无标题）",c,l),g=w(yield T(t,o,f,void 0,{stream:!1,systemMessage:d}),e.title,a),m=!!g.title&&g.title!==e.title,p=g.tags.length>0;if(!m&&!p)return void(yield n.default.views.dialogs.showMessageBox("AI 未生成有效的标题或标签。"));m&&(yield n.default.data.put(["notes",e.id],null,{title:g.title}));let v={added:0,removed:0,final:[]};p&&(v=yield N(e.id,g.tags),(v.added||v.removed)&&(yield h()));const S=[];if(m&&S.push(`标题已更新为「${g.title}」`),p&&(v.added||v.removed||v.final.length)){const e=[];v.final.length&&e.push(`标签：${v.final.join(", ")}`),v.added&&e.push(`新增 ${v.added}`),v.removed&&e.push(`移除 ${v.removed}`),S.push(e.join("，"))}yield n.default.views.dialogs.showToast({message:S.join("；")||"AI 已更新当前笔记。",type:r.ToastType.Success,duration:5e3})}catch(e){console.error("AI Generate Title (current note) error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiClearTagsForCurrentNote",label:"AI Clear Tags for Current Note",iconName:"fas fa-eraser",execute:()=>i(this,void 0,void 0,function*(){try{const e=yield n.default.workspace.selectedNote();if(!e)return void(yield n.default.views.dialogs.showMessageBox("Please open a note first."));const t=yield B(e.id);t>0&&(yield h()),yield n.default.views.dialogs.showToast({message:t?`已移除当前笔记的 ${t} 个标签。`:"当前笔记没有可移除的标签。",type:r.ToastType.Info,duration:4e3})}catch(e){console.error("AI Clear Tags (current note) error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiGenerateTitlesForCurrentNotebook",label:"AI Generate Titles for Current Notebook",iconName:"fas fa-book-open",execute:()=>i(this,void 0,void 0,function*(){try{const e=yield F();if(!e)return void(yield n.default.views.dialogs.showMessageBox("请先选择一个笔记或笔记本。"));const t=yield n.default.settings.value("baseUrl"),o=yield n.default.settings.value("apiKey");if(!o||""===o.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const s=String((yield n.default.settings.value("titleSystemPrompt"))||""),a=String((yield n.default.settings.value("tagSystemPrompt"))||""),l=P(yield n.default.settings.value("tagLimit")),d=yield y(),u=new Set(d),c=20;let f=0,g=0,m=0,p=0,v=0,S=0,x=!1;const A=[],I=[];yield E(e.id,["id","title","body"],c,e=>i(this,void 0,void 0,function*(){if(!e||"string"!=typeof e.id)return;f++;const i="string"==typeof e.body?e.body:"";if(!i.trim())return void I.push(e.id);const r=b(i,4e3),d=Array.from(u),c=L(s,a,l,d),y=k(e.title||"（无标题）",r,d);try{const i=w(yield T(t,o,y,void 0,{stream:!1,systemMessage:c}),e.title,l),r=!!i.title&&i.title!==e.title,s=i.tags.length>0;if(!r&&!s)return void I.push(e.id);let a=!1;r&&(yield n.default.data.put(["notes",e.id],null,{title:i.title}),a=!0,g++);let d=!1;if(s){const t=yield N(e.id,i.tags);if(Array.isArray(t.final)&&t.final.length)for(const e of t.final)u.add(e);(t.added||t.removed)&&(d=!0,x=!0),t.added&&(v+=t.added),t.removed&&(S+=t.removed),(t.added||t.removed)&&(p+=1)}a||d?(a||g++,a&&(m+=1)):I.push(e.id)}catch(t){const o=t instanceof Error?t.message:`${t}`;A.push(`${e.id}: ${o}`),console.error(`Failed to update title for note ${e.id}:`,t)}})),x?yield h():yield y();const $=[`Notebook: ${e.title||e.id}`,`Processed: ${f}`,`Updated Notes: ${g}`,`Titles Updated: ${m}`,`Tag Adjustments: ${p} (+${v}/-${S})`,`Skipped: ${I.length}`,A.length?`Errors: ${A.length}`:""].filter(Boolean).join(", ");console.info(`AI notebook title generation summary: ${$}`);const C=e.title?`笔记本「${e.title}」`:"当前笔记本",M=A.length?`${C}批量更新完成：标题 ${m}，标签 ${p}，跳过 ${I.length}，错误 ${A.length}`:`${C}批量更新完成：标题 ${m}，标签 ${p}，跳过 ${I.length}`;yield n.default.views.dialogs.showToast({message:M,type:A.length?r.ToastType.Info:r.ToastType.Success,duration:8e3})}catch(e){console.error("AI Generate Titles (current notebook) error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiClearTagsForCurrentNotebook",label:"AI Clear Tags for Current Notebook",iconName:"fas fa-book",execute:()=>i(this,void 0,void 0,function*(){try{const e=yield F();if(!e)return void(yield n.default.views.dialogs.showMessageBox("请先选择一个笔记或笔记本。"));const t=50;let o=0,s=0,a=0;yield E(e.id,["id","title"],t,e=>i(this,void 0,void 0,function*(){if(!e||"string"!=typeof e.id)return;o++;const t=yield B(e.id);t>0&&(s++,a+=t)})),console.info(`AI notebook clear tags summary: notebook=${e.title||e.id}, processed=${o}, cleared=${s}, tagsRemoved=${a}`),a>0?yield h():yield y();const l=e.title?`笔记本「${e.title}」`:"当前笔记本";yield n.default.views.dialogs.showToast({message:a?`已从${l}的 ${s} 篇笔记移除 ${a} 个标签。`:`${l}中的所有笔记均无可移除的标签。`,type:a?r.ToastType.Success:r.ToastType.Info,duration:6e3})}catch(e){console.error("AI Clear Tags (current notebook) error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiGenerateTitlesForAllNotes",label:"AI Generate Titles for All Notes",iconName:"fas fa-clipboard-list",execute:()=>i(this,void 0,void 0,function*(){try{const e=yield n.default.settings.value("baseUrl"),t=yield n.default.settings.value("apiKey");if(!t||""===t.trim())return void(yield n.default.views.dialogs.showMessageBox("Please configure your API Key in settings first."));const o=String((yield n.default.settings.value("titleSystemPrompt"))||""),i=String((yield n.default.settings.value("tagSystemPrompt"))||""),s=P(yield n.default.settings.value("tagLimit")),a=yield y(),l=new Set(a),d=20;let u=1,c=0,f=0,g=0,m=0,p=0,v=0,S=!1;const x=[],A=[];for(;;){const r=yield n.default.data.get(["notes"],{fields:["id","title","body"],limit:d,page:u}),a=r.items||[];if(!a.length)break;for(const r of a){c++;const a="string"==typeof r.body?r.body:"";if(!a.trim()){A.push(r.id);continue}const d=b(a,4e3),u=Array.from(l),y=L(o,i,s,u),h=k(r.title||"（无标题）",d,u);try{const o=w(yield T(e,t,h,void 0,{stream:!1,systemMessage:y}),r.title,s),i=!!o.title&&o.title!==r.title,a=o.tags.length>0;if(!i&&!a){A.push(r.id);continue}let d=!1;i&&(yield n.default.data.put(["notes",r.id],null,{title:o.title}),d=!0,f++);let u=!1;if(a){const e=yield N(r.id,o.tags);if(Array.isArray(e.final)&&e.final.length)for(const t of e.final)l.add(t);(e.added||e.removed)&&(u=!0,S=!0),e.added&&(p+=e.added),e.removed&&(v+=e.removed),(e.added||e.removed)&&(m+=1)}d||u?(d||f++,d&&(g+=1)):A.push(r.id)}catch(e){const t=e instanceof Error?e.message:`${e}`;x.push(`${r.id}: ${t}`),console.error(`Failed to update title for note ${r.id}:`,e)}}if(!r.has_more)break;u+=1}S?yield h():yield y();const I=[`Processed: ${c}`,`Updated Notes: ${f}`,`Titles Updated: ${g}`,`Tag Adjustments: ${m} (+${p}/-${v})`,`Skipped: ${A.length}`,x.length?`Errors: ${x.length}`:""].filter(Boolean).join(", ");console.info(`AI title generation summary: ${I}`);const $=x.length?`AI 批量更新完成：标题 ${g}，标签 ${m}，跳过 ${A.length}，错误 ${x.length}`:`AI 批量更新完成：标题 ${g}，标签 ${m}，跳过 ${A.length}`;yield n.default.views.dialogs.showToast({message:$,type:x.length?r.ToastType.Info:r.ToastType.Success,duration:8e3})}catch(e){console.error("AI Generate Titles error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.commands.register({name:"aiClearTagsForAllNotes",label:"AI Clear Tags for All Notes",iconName:"fas fa-broom",execute:()=>i(this,void 0,void 0,function*(){try{const e=50;let t=1,o=0,i=0,s=0;for(;;){const r=yield n.default.data.get(["notes"],{fields:["id","title"],limit:e,page:t}),a=r.items||[];if(!a.length)break;for(const e of a){o++;const t=yield B(e.id);t>0&&(i++,s+=t)}if(!r.has_more)break;t+=1}console.info(`AI clear tags summary: processed ${o}, cleared ${i}, tags removed ${s}`),s>0?yield h():yield y(),yield n.default.views.dialogs.showToast({message:s?`已从 ${i} 篇笔记移除 ${s} 个标签。`:"所有笔记均无可移除的标签。",type:s?r.ToastType.Success:r.ToastType.Info,duration:6e3})}catch(e){console.error("AI Clear Tags (all notes) error:",e),yield n.default.views.dialogs.showMessageBox(`Error: ${e.message}`)}})}),yield n.default.views.toolbarButtons.create("aiChatButton","aiChatWithSelection",r.ToolbarButtonLocation.EditorToolbar),yield n.default.views.toolbarButtons.create("aiGenerateTitleCurrentButton","aiGenerateTitleForCurrentNote",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiClearTagsCurrentButton","aiClearTagsForCurrentNote",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiGenerateTitlesNotebookButton","aiGenerateTitlesForCurrentNotebook",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiClearTagsNotebookButton","aiClearTagsForCurrentNotebook",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiGenerateTitlesButton","aiGenerateTitlesForAllNotes",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.toolbarButtons.create("aiClearTagsAllButton","aiClearTagsForAllNotes",r.ToolbarButtonLocation.NoteToolbar),yield n.default.views.menus.create("aiToolsMenu","AI Tools",[{commandName:"aiEditPrompts"},{commandName:"aiShowTagPool"},{commandName:"aiGenerateTitleForCurrentNote"},{commandName:"aiClearTagsForCurrentNote"},{commandName:"aiGenerateTitlesForCurrentNotebook"},{commandName:"aiClearTagsForCurrentNotebook"},{commandName:"aiGenerateTitlesForAllNotes",accelerator:"CmdOrCtrl+Shift+T"},{commandName:"aiClearTagsForAllNotes"}],r.MenuItemLocation.Tools),console.info("AI Tools plugin started!")})}})},611:e=>{e.exports=require("http")},692:e=>{e.exports=require("https")},998:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=joplin}},t={};!function o(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,o),r.exports}(156)})();